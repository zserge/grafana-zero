"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1598],{"./public/app/plugins/datasource/loki/module.ts":(e,t,s)=>{s.r(t),s.d(t,{plugin:()=>St});var a=s("./packages/grafana-data/src/index.ts"),r=s("./.yarn/cache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),n=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),i=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),o=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),l=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),c=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),d=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/switchMap.js"),p=s("./.yarn/cache/prismjs-npm-1.25.0-8d60169ac0-04d8eae9d1.zip/node_modules/prismjs/prism.js"),h=s.n(p),m=s("./packages/grafana-runtime/src/index.ts"),g=s("./public/app/features/templating/template_srv.ts"),f=s("./public/app/plugins/datasource/prometheus/add_label_to_query.ts"),b=s("./public/app/features/dashboard/services/TimeSrv.ts"),y=s("./public/app/core/utils/explore.ts"),v=s("./.yarn/cache/uuid-npm-8.3.0-2f98335399-b539886e6a.zip/node_modules/uuid/dist/esm-browser/stringify.js"),x=s("./.yarn/cache/uuid-npm-8.3.0-2f98335399-b539886e6a.zip/node_modules/uuid/dist/esm-browser/validate.js");const j=function(e){if(!(0,x.Z)(e))throw TypeError("Invalid UUID");var t,s=new Uint8Array(16);return s[0]=(t=parseInt(e.slice(0,8),16))>>>24,s[1]=t>>>16&255,s[2]=t>>>8&255,s[3]=255&t,s[4]=(t=parseInt(e.slice(9,13),16))>>>8,s[5]=255&t,s[6]=(t=parseInt(e.slice(14,18),16))>>>8,s[7]=255&t,s[8]=(t=parseInt(e.slice(19,23),16))>>>8,s[9]=255&t,s[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,s[11]=t/4294967296&255,s[12]=t>>>24&255,s[13]=t>>>16&255,s[14]=t>>>8&255,s[15]=255&t,s};function _(e,t,s,a){switch(e){case 0:return t&s^~t&a;case 1:case 3:return t^s^a;case 2:return t&s^t&a^s&a}}function w(e,t){return e<<t|e>>>32-t}var k=function(e,t,s){function a(e,a,r,n){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],s=0;s<e.length;++s)t.push(e.charCodeAt(s));return t}(e)),"string"==typeof a&&(a=j(a)),16!==a.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(a),i.set(e,a.length),(i=s(i))[6]=15&i[6]|t,i[8]=63&i[8]|128,r){n=n||0;for(var o=0;o<16;++o)r[n+o]=i[o];return r}return(0,v.Z)(i)}try{a.name=e}catch(e){}return a.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",a.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",a}("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],s=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var r=0;r<a.length;++r)e.push(a.charCodeAt(r))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var n=e.length/4+2,i=Math.ceil(n/16),o=new Array(i),l=0;l<i;++l){for(var c=new Uint32Array(16),u=0;u<16;++u)c[u]=e[64*l+4*u]<<24|e[64*l+4*u+1]<<16|e[64*l+4*u+2]<<8|e[64*l+4*u+3];o[l]=c}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var p=new Uint32Array(80),h=0;h<16;++h)p[h]=o[d][h];for(var m=16;m<80;++m)p[m]=w(p[m-3]^p[m-8]^p[m-14]^p[m-16],1);for(var g=s[0],f=s[1],b=s[2],y=s[3],v=s[4],x=0;x<80;++x){var j=Math.floor(x/20),k=w(g,5)+_(j,f,b,y)+v+t[j]+p[x]>>>0;v=y,y=b,b=w(f,30)>>>0,f=g,g=k}s[0]=s[0]+g>>>0,s[1]=s[1]+f>>>0,s[2]=s[2]+b>>>0,s[3]=s[3]+y>>>0,s[4]=s[4]+v>>>0}return[s[0]>>24&255,s[0]>>16&255,s[0]>>8&255,255&s[0],s[1]>>24&255,s[1]>>16&255,s[1]>>8&255,255&s[1],s[2]>>24&255,s[2]>>16&255,s[2]>>8&255,255&s[2],s[3]>>24&255,s[3]>>16&255,s[3]>>8&255,255&s[3],s[4]>>24&255,s[4]>>16&255,s[4]>>8&255,255&s[4]]}));const L=k;var T=s("./public/app/core/table_model.ts"),S=s("./public/app/plugins/datasource/loki/syntax.ts");function C(e){return`${e||""}`.trim()}function F(e){let t=e;const s=[];for(;t;){const e=t.search(/\|=|\|~|!=|!~/);if(-1===e)break;const a=t.substr(e,2),n=0===t.substr(e).search(/!=|!~/);if(t=t.substr(e+2),n)continue;const i=t.search(/\|=|\|~|!=|!~/);let o;-1===i?o=t.trim():(o=t.substr(0,i).trim(),t=t.substr(i));const l=o.match(/"(.*?)"/),c=o.match(/`(.*?)`/),u=l||c;if(!u)return s;{const e=u[1];"|~"===a?s.push(c?e:e.replace(/\\\\/g,"\\")):s.push((0,r.escapeRegExp)(e))}}return s}let $;!function(e){e.Stream="streams",e.Vector="vector",e.Matrix="matrix"}($||($={}));function I(e,t,s){const r=e.stream,n=Object.entries(r).map((e=>{let[t,s]=e;return`${t}="${s}"`})).sort().join(""),i=new a.ArrayVector([]),o=new a.ArrayVector([]),l=new a.ArrayVector([]),c=new a.ArrayVector([]),u={};for(const[t,a]of e.values)i.add(new Date(parseInt(t.substr(0,t.length-6),10)).toISOString()),o.add(t),l.add(a),c.add(O(t,n,a,u,s));return function(e,t,s,r,n,i,o){const l={refId:o,fields:[{name:"ts",type:a.FieldType.time,config:{displayName:"Time"},values:e},{name:"line",type:a.FieldType.string,config:{},values:s,labels:n},{name:"id",type:a.FieldType.string,config:{},values:r},{name:"tsNs",type:a.FieldType.time,config:{displayName:"Time ns"},values:t}],length:e.length};if(i){const e=new a.MutableDataFrame(l);return e.reverse(),e}return l}(i,o,l,c,r,t,s)}function O(e,t,s,a,r){let n=L(`${e}_${t}_${s}`,"6ec946da-0f49-47a8-983a-1d76d17e7c92");if(n in a){const e=a[n]+1;a[n]=e,n=`${n}_${e}`}else a[n]=0;return r?`${n}_${r}`:n}function R(e,t){const s=function(e,t){var s;let a=void 0===t||(0,r.isEmpty)(t.legendFormat)?function(e){const t=e.__name__||"";delete e.__name__;const s=Object.entries(e).map((e=>`${e[0]}="${e[1]}"`)).join(",");return`${t}{${s}}`}(e):function(e,t){const s=/\{\{\s*(.+?)\s*\}\}/g;return e.replace(s,((e,s)=>t[s]?t[s]:s))}((0,m.getTemplateSrv)().replace(null!==(s=t.legendFormat)&&void 0!==s?s:"",t.scopedVars),e);!a&&t&&(a=t.query);return a}(e.metric,t);return{target:s,title:s,datapoints:Q(e.values,t),tags:e.metric,meta:t.meta,refId:t.refId}}function Q(e,t){const s=1e3*t.step,a=[];let r=t.start/1e6;for(const[t,n]of e){let e=parseFloat(n);isNaN(e)&&(e=null);const i=1e3*t;for(let e=r;e<i;e+=s)a.push([null,e]);r=i+s,a.push([e,i])}const n=t.end/1e6;for(let e=r;e<=n;e+=s)a.push([null,e]);return a}function N(e,t,s,r,n){if(!e||0===e.length)return new T.Z;const i=[...new Set(e.reduce(((e,t)=>e.concat(Object.keys(t.metric))),[])).values()].sort(),o=new T.Z;return o.refId=s,o.meta=r,o.columns=[{text:"Time",type:a.FieldType.time},...i.map((e=>({text:e,filterable:!0,type:a.FieldType.string}))),{text:t>1||n?`Value #${s}`:"Value",type:a.FieldType.number}],e.forEach((e=>{const t={metric:e.metric,values:e.value?[e.value]:e.values};t.values&&(t.metric?o.rows.push(...t.values.map((e=>{let[s,a]=e;return[1e3*s,...i.map((e=>t.metric[e]||"")),parseFloat(a)]}))):o.rows.concat(t.values.map((e=>{let[t,s]=e;return[1e3*t,parseFloat(s)]}))))})),o}function D(e){const t=[];if(!e)return t;for(const a in e){const n=e[a];for(const e in n){const i=n[e];let o;/time/i.test(e)&&i?o="s":/bytes.*persecond/i.test(e)?o="Bps":/bytes/i.test(e)&&(o="decbytes");const l=`${(0,r.capitalize)(a)}: ${s=e,s.replace(/[A-Z]/g,(e=>` ${e.toLowerCase()}`))}`;t.push({displayName:l,value:i,unit:o})}}var s;return t}function q(e,t,s,a){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const n=s>0?e.data.result:[],i=D(e.data.stats),o={lokiQueryStatKey:"Summary: total bytes processed"},l={searchWords:F(C(t.expr)),limit:s,stats:i,custom:o,preferredVisualisationType:"logs"},c=n.map((e=>{const s=I(e,r,t.refId);return E(s,a),l.custom&&s.fields.some((e=>e.labels&&Object.keys(e.labels).some((e=>"__error__"===e))))&&(l.custom.error="Error when parsing some of the logs"),Object.assign({},s,{refId:t.refId,meta:l})}));return i.length&&!n.length?[{fields:[],length:0,refId:t.refId,meta:l}]:c}const E=(e,t)=>{var s;if(!t)return;const n=null!==(s=t.derivedFields)&&void 0!==s?s:[];if(!n.length)return;const i=(0,r.groupBy)(n,"name"),o=Object.values(i).map(V);new a.DataFrameView(e).forEach((e=>{for(const t of o){const s=e.line.match(i[t.name][0].matcherRegex);t.values.add(s&&s[1])}})),e.fields=[...e.fields,...o]};function V(e){const t=(0,m.getDataSourceSrv)(),s=e.reduce(((e,s)=>{if(s.datasourceUid){var a;const r=t.getInstanceSettings(s.datasourceUid);e.push({title:s.urlDisplayLabel||"",url:"",internal:{query:{query:s.url},datasourceUid:s.datasourceUid,datasourceName:null!==(a=null==r?void 0:r.name)&&void 0!==a?a:"Data source not found"}})}else s.url&&e.push({title:s.urlDisplayLabel||"",url:s.url});return e}),[]);return{name:e[0].name,type:a.FieldType.string,config:{links:s},values:new a.ArrayVector([])}}function A(e,t,s,a,r){var n;const i={format:s.format,legendFormat:null!==(n=s.legendFormat)&&void 0!==n?n:"",start:t.start,end:t.end,step:t.step,query:t.query,responseListLength:a,refId:s.refId,meta:{preferredVisualisationType:"graph"},valueWithRefId:s.valueWithRefId,scopedVars:r};switch(e.data.resultType){case $.Vector:return e.data.result.map((e=>R({metric:e.metric,values:[e.value]},i)));case $.Matrix:return e.data.result.map((e=>R(e,i)));default:return[]}}function z(e,t,s,a,r,n,i){let l=arguments.length>7&&void 0!==arguments[7]&&arguments[7];switch(e.data.resultType){case $.Stream:return(0,o.of)({data:q(e,t,r,n,l),key:`${t.refId}_log`});case $.Vector:case $.Matrix:return(0,o.of)({data:A(e,s,Object.assign({},t,{format:"time_series"}),a,i),key:t.refId});default:throw new Error(`Unknown result type "${e.data.resultType}".`)}}var U=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/timer.js"),P=s("./.yarn/cache/tslib-npm-2.1.0-81c9ac9b82-aa189c8179.zip/node_modules/tslib/tslib.es6.js"),M=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/Subject.js"),W=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/Subscriber.js"),K=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/Observable.js"),B=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/Subscription.js"),Z=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/ReplaySubject.js"),H={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},J=function(e){function t(t,s){var a=e.call(this)||this;if(a._socket=null,t instanceof K.y)a.destination=s,a.source=t;else{var r=a._config=(0,P.pi)({},H);if(a._output=new M.x,"string"==typeof t)r.url=t;else for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);if(!r.WebSocketCtor&&WebSocket)r.WebSocketCtor=WebSocket;else if(!r.WebSocketCtor)throw new Error("no WebSocket constructor can be found");a.destination=new Z.t}return a}return(0,P.ZT)(t,e),t.prototype.lift=function(e){var s=new t(this._config,this.destination);return s.operator=e,s.source=this,s},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new Z.t),this._output=new M.x},t.prototype.multiplex=function(e,t,s){var a=this;return new K.y((function(r){try{a.next(e())}catch(e){r.error(e)}var n=a.subscribe((function(e){try{s(e)&&r.next(e)}catch(e){r.error(e)}}),(function(e){return r.error(e)}),(function(){return r.complete()}));return function(){try{a.next(t())}catch(e){r.error(e)}n.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,s=t.WebSocketCtor,a=t.protocol,r=t.url,n=t.binaryType,i=this._output,o=null;try{o=a?new s(r,a):new s(r),this._socket=o,n&&(this._socket.binaryType=n)}catch(e){return void i.error(e)}var l=new B.w0((function(){e._socket=null,o&&1===o.readyState&&o.close()}));o.onopen=function(t){if(!e._socket)return o.close(),void e._resetState();var s=e._config.openObserver;s&&s.next(t);var a=e.destination;e.destination=W.Lv.create((function(t){if(1===o.readyState)try{var s=e._config.serializer;o.send(s(t))}catch(t){e.destination.error(t)}}),(function(t){var s=e._config.closingObserver;s&&s.next(void 0),t&&t.code?o.close(t.code,t.reason):i.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),o.close(),e._resetState()})),a&&a instanceof Z.t&&l.add(a.subscribe(e.destination))},o.onerror=function(t){e._resetState(),i.error(t)},o.onclose=function(t){e._resetState();var s=e._config.closeObserver;s&&s.next(t),t.wasClean?i.complete():i.error(t)},o.onmessage=function(t){try{var s=e._config.deserializer;i.next(s(t))}catch(e){i.error(e)}}},t.prototype._subscribe=function(e){var t=this,s=this.source;return s?s.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;!t||1!==t.readyState&&0!==t.readyState||t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(M.u);var X=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/retryWhen.js"),Y=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),G=s("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/finalize.js");class ee{constructor(){var e,t,s;s={},(t="streams")in(e=this)?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}getStream(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,s=this.streams[e.url];if(s)return s;const r=new a.CircularDataFrame({capacity:e.size});var i;return r.addField({name:"ts",type:a.FieldType.time,config:{displayName:"Time"}}),r.addField({name:"tsNs",type:a.FieldType.time,config:{displayName:"Time ns"}}),r.addField({name:"line",type:a.FieldType.string}).labels=(0,a.parseLabels)(e.query),r.addField({name:"labels",type:a.FieldType.other}),r.addField({name:"id",type:a.FieldType.string}),r.meta=Object.assign({},r.meta,{preferredVisualisationType:"logs"}),r.refId=e.refId,s=(i=e.url,new J(i)).pipe((0,c.U)((e=>(function(e,t){const s=e.streams;if(!s||!s.length)return;let r={};for(const e of t.fields)if(e.type===a.FieldType.string){e.labels&&(r=e.labels);break}const n=t.fields[0],i=t.fields[1],o=t.fields[2],l=t.fields[3],c=t.fields[4],u={};for(const e of s){const s=(0,a.findUniqueLabels)(e.stream,r),d=Object.entries(e.stream).map((e=>{let[t,s]=e;return`${t}="${s}"`})).sort().join("");for(const[a,r]of e.values)n.values.add(new Date(parseInt(a.substr(0,a.length-6),10)).toISOString()),i.values.add(a),o.values.add(r),l.values.add(s),c.values.add(O(a,d,r,u,t.refId))}}(e,r),[r]))),(0,X.a)((e=>e.pipe((0,Y.z)(((e,s)=>{const a=s+1;return 1006===e.code&&a<30?(a>10&&console.warn(`Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: ${e.reason}`),(0,U.H)(t)):(0,n._)(e)}))))),(0,G.x)((()=>{delete this.streams[e.url]}))),this.streams[e.url]=s,s}}var te=s("./.yarn/cache/lru-cache-npm-6.0.0-b4c8668fe1-f97f499f89.zip/node_modules/lru-cache/index.js"),se=s.n(te),ae=s("./public/app/plugins/datasource/prometheus/language_utils.ts"),re=s("./public/app/plugins/datasource/graphite/graphite_query.ts");const ne={"=":"=","!=":"!=","=~":"=~","!=~":"!~"};function ie(e,t){let s=!1,a={};if(e.seriesByTagUsed)s=!0,e.tags.forEach((e=>{a[e.key]={value:e.value,operator:ne[e.operator]}}));else{const r=e.segments.map((e=>e.value));let n=t.mappings.filter((e=>e.matchers.length<=r.length));for(let e of n){s=e.matchers.concat().every(((e,t)=>{if(e.labelName){let n=r[t];if("*"===n)return!0;const i=(s=n).includes("*")||s.includes("{")?"^"+s.replace(/\*/g,".*").replace(/\{/g,"(").replace(/}/g,")").replace(/,/g,"|"):s;return a[e.labelName]={value:i,operator:i!==n?"=~":"="},!0}var s;return r[t]===e.value||"*"===e.value}))}}let n=(0,r.map)(a,((e,t)=>`${t}${e.operator}"${e.value}"`));return s&&n.length?`{${n.join(", ")}}`:""}function oe(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const le=["job","namespace"],ce="{}",ue=[{label:"$__interval",sortValue:"$__interval"},{label:"$__range",sortValue:"$__range"},{label:"1m",sortValue:"00:01:00"},{label:"5m",sortValue:"00:05:00"},{label:"10m",sortValue:"00:10:00"},{label:"30m",sortValue:"00:30:00"},{label:"1h",sortValue:"01:00:00"},{label:"1d",sortValue:"24:00:00"}],de=e=>({label:e,filterText:`"${e}"`});class pe extends a.LanguageProvider{constructor(e,t){super(),oe(this,"labelKeys",void 0),oe(this,"labelFetchTs",void 0),oe(this,"started",!1),oe(this,"datasource",void 0),oe(this,"lookupsDisabled",!1),oe(this,"seriesCache",new(se())(10)),oe(this,"labelsCache",new(se())(10)),oe(this,"cleanText",(e=>e.replace(/[{}[\]="(),!~+\-*/^%\|]/g,"").trim())),oe(this,"request",(async(e,t)=>{try{return await this.datasource.metadataRequest(e,t)}catch(e){console.error(e)}})),oe(this,"start",(()=>(this.startTask||(this.startTask=this.fetchLabels().then((()=>(this.started=!0,[])))),this.startTask))),oe(this,"getBeginningCompletionItems",(e=>({suggestions:[...this.getEmptyCompletionItems(e).suggestions,...this.getTermCompletionItems().suggestions]}))),oe(this,"getTermCompletionItems",(()=>{const e=[];return e.push({prefixMatch:!0,label:"Functions",items:S.r8.map((e=>Object.assign({},e,{kind:"function"})))}),{suggestions:e}})),oe(this,"getPipeCompletionItem",(()=>{const e=[];return e.push({label:"Operators",items:S.Rd.map((e=>Object.assign({},e,{kind:"operators"})))}),e.push({label:"Parsers",items:S.uR.map((e=>Object.assign({},e,{kind:"parsers"})))}),{suggestions:e}})),oe(this,"fetchSeriesLabels",(async e=>{const t="/loki/api/v1/series",{start:s,end:a}=this.datasource.getTimeRangeParams(),r=this.generateCacheKey(t,s,a,e);let n=this.seriesCache.get(r);if(!n){this.seriesCache.set(r,{});const i={"match[]":e,start:s,end:a},o=await this.request(t,i),{values:l}=(0,ae.DY)(o);n=l,this.seriesCache.set(r,n)}return n})),oe(this,"fetchSeries",(async e=>{const{start:t,end:s}=this.datasource.getTimeRangeParams(),a={"match[]":e,start:t,end:s};return await this.request("/loki/api/v1/series",a)})),this.datasource=e,this.labelKeys=[],this.labelFetchTs=0,Object.assign(this,t)}getSyntax(){return S.ZP}getLabelKeys(){return this.labelKeys}async provideCompletionItems(e,t){const{wrapperClasses:s,value:a,prefix:r,text:n}=e,i={suggestions:[]};if(!a)return i;const o=0===(null==a?void 0:a.document.text.length),l=a.document.getTextsAtRange(a.selection),c=1===l.size?l.first().getText():null,u=c?c[a.selection.anchor.offset]:null,d=s.length>3,p=r&&!d,h=!u||")"===u,m=r&&!n.match(/^['"~=\]})\s]+$/)&&h,g=n.match(/[+\-*/^%]/);return s.includes("context-range")?this.getRangeCompletionItems():s.includes("context-labels")?await this.getLabelCompletionItems(e):s.includes("context-pipe")?this.getPipeCompletionItem():o?this.getEmptyCompletionItems(t):p&&h&&!g?this.getBeginningCompletionItems(t):p&&m?this.getTermCompletionItems():i}getEmptyCompletionItems(e){const t=null==e?void 0:e.history,s=[];if(null!=t&&t.length){const e=(0,r.chain)(t).map((e=>e.query.expr)).filter().uniq().take(10).map(de).map((e=>function(e,t){const s=Date.now()-864e5,r=t.filter((t=>t.ts>s&&t.query.expr===e.label));let n=`Queried ${r.length} times in the last 24h.`;const i=r[0];i&&(n=`${n} Last queried ${(0,a.dateTime)(i.ts).fromNow()}.`);return Object.assign({},e,{documentation:n})}(e,t))).value();s.push({prefixMatch:!0,skipSort:!0,label:"History",items:e})}return{suggestions:s}}getRangeCompletionItems(){return{context:"context-range",suggestions:[{label:"Range vector",items:[...ue]}]}}async getLabelCompletionItems(e){let{text:t,wrapperClasses:s,labelKey:a,value:n}=e,i="context-labels";const o=[];if(!n)return{context:i,suggestions:[]};const l=n.anchorBlock.getText(),c=n.selection.anchor.offset,u=t.match(/^(=|=~|!=|!~)/);let d,p;try{p=(0,ae.rV)(l,c),d=p.selector}catch{d=ce}if(!a&&d===ce){await this.start();return{context:i,suggestions:[{label:"Labels",items:this.getLabelKeys().map(de)}]}}const h=p?p.labelKeys:[];let m;if(d)if(d===ce&&a){m={[a]:await this.getLabelValues(a)}}else m=await this.getSeriesLabels(d);if(!m)return console.warn(`Server did not return any values for selector = ${d}`),{context:i,suggestions:o};if(t&&u||s.includes("attr-value"))a&&m[a]&&(i="context-label-values",o.push({label:`Label values for "${a}"`,items:m[a].map(de).filter((e=>{let{filterText:s}=e;return s!==t}))}));else{const e=m?Object.keys(m):le;if(e){const t=(0,r.difference)(e,h);if(t.length){const e={label:"Labels",items:t.map((e=>({label:e})))};o.push(e)}}}return{context:i,suggestions:o}}async importQueries(e,t){const s=t.meta.id;return"prometheus"===s?Promise.all([...e].map((async e=>{const t=await this.importPrometheusQuery(e.expr),{refId:s}=e;return{expr:t,refId:s,range:!0}}))):"graphite"===s?(a=t,e.map((e=>{const t=new re.Z(a,Object.assign({},e,{target:e.target||"",textEditor:!1}),(0,g.J)());return t.parseTarget(),{refId:e.refId,expr:ie(t,a.getImportQueryConfiguration().loki)}}))):e.map((e=>({refId:e.refId,expr:""})));var a}async importPrometheusQuery(e){if(!e)return"";const t=e.match(ae.V2);if(!t)return"";const s=t[0],a={};s.replace(ae.aw,((e,t,s,r)=>(a[t]={value:r,operator:s},""))),await this.start();const r=this.labelKeys;let n={};if(r&&r.length)for(const e in a)r&&r.includes(e)&&(n[e]=a[e]);else n=a;return["{",Object.keys(n).sort().map((e=>`${e}${n[e].operator}${n[e].value}`)).join(","),"}"].join("")}async getSeriesLabels(e){if(!this.lookupsDisabled)try{return await this.fetchSeriesLabels(e)}catch(e){return void console.error(e)}}async fetchLabels(){const e=this.datasource.getTimeRangeParams();this.labelFetchTs=Date.now().valueOf();const t=await this.request("/loki/api/v1/label",e);if(Array.isArray(t)){const e=t.slice().sort().filter((e=>"__name__"!==e));this.labelKeys=e}return[]}async refreshLogLabels(e){(this.labelKeys&&Date.now().valueOf()-this.labelFetchTs>3e4||e)&&await this.fetchLabels()}generateCacheKey(e,t,s,a){return[e,this.roundTime(t),this.roundTime(s),a].join()}roundTime(e){return e?Math.floor(e/1e6/1e3/60/5):0}async getLabelValues(e){return await this.fetchLabelValues(e)}async fetchLabelValues(e){var t;const s=`/loki/api/v1/label/${e}/values`,a=this.datasource.getTimeRangeParams(),{start:r,end:n}=a,i=this.generateCacheKey(s,r,n,e),o={start:r,end:n};let l=this.labelsCache.get(i);if(!l){this.labelsCache.set(i,[]);const e=await this.request(s,o);Array.isArray(e)&&(l=e.slice().sort(),this.labelsCache.set(i,l))}return null!==(t=l)&&void 0!==t?t:[]}}var he=s("./public/app/core/utils/fetch.ts"),me=s("./public/app/plugins/datasource/loki/components/LokiOptionFields.tsx"),ge=s("./public/app/core/logs_model.ts"),fe=s("./public/app/core/config.ts");function be(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const ye=1e6,ve="/loki/api/v1/query_range",xe="/loki/api/v1/query",je={direction:"BACKWARD",limit:1e3,query:""};class _e extends a.DataSourceApi{constructor(e){var t,s;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.J)(),l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,b.$t)();super(e),t=this,be(this,"streams",new ee),be(this,"languageProvider",void 0),be(this,"maxLines",void 0),be(this,"runInstantQuery",(function(e,s){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const r=t.getTime(s.range.to,!0),i=Te(e.expr)?s.maxDataPoints:e.maxLines,o={query:e.expr,time:`${r+(1e9-r%1e9)}`,limit:Math.min(i||1/0,t.maxLines)},l={preferredVisualisationType:"table"};return t._request(xe,o).pipe((0,c.U)((s=>s.data.data.resultType===$.Stream?{data:s.data?q(s.data,e,o.limit,t.instanceSettings.jsonData):[],key:`${e.refId}_instant`}:{data:[N(s.data.data.result,a,e.refId,l,!0)],key:`${e.refId}_instant`})),(0,u.K)((s=>(0,n._)((()=>t.processError(s,e))))))})),be(this,"runRangeQuery",(function(e,s){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=Te(e.expr)?s.maxDataPoints||t.maxLines:e.maxLines||t.maxLines;if(s.liveStreaming)return t.runLiveQuery(e,r);const i=t.createRangeQuery(e,s,r),o=e.volumeQuery?{"X-Query-Tags":"Source=logvolhist"}:void 0;return t._request(ve,i,{headers:o}).pipe((0,u.K)((s=>(0,n._)((()=>t.processError(s,e))))),(0,d.w)((n=>z(n.data,e,i,a,r,t.instanceSettings.jsonData,s.scopedVars,s.reverse))))})),be(this,"runLiveQuery",((e,t)=>{const s=this.createLiveTarget(e,t);return this.streams.getStream(s).pipe((0,c.U)((e=>({data:e||[],key:`loki-${s.refId}`,state:a.LoadingState.Streaming}))),(0,u.K)((e=>(0,n._)((()=>`Live tailing was stopped due to following error: ${e.reason}`)))))})),be(this,"getLogRowContext",((e,t)=>{const s=this.prepareLogRowContextQueryTarget(e,t&&t.limit||10,t&&t.direction||"BACKWARD"),a=t&&"FORWARD"===t.direction;return(0,i.n)(this._request(ve,s).pipe((0,u.K)((e=>{throw{message:"Error during context query. Please check JS console logs.",status:e.status,statusText:e.statusText}})),(0,d.w)((e=>(0,o.of)({data:e.data?e.data.data.result.map((e=>I(e,a))):[]})))))})),be(this,"prepareLogRowContextQueryTarget",((e,t,s)=>{const r=this.languageProvider.getLabelKeys(),n=Object.keys(e.labels).map((t=>r.includes(t)?`${t}="${e.labels[t].replace(/\\/g,"\\\\")}"`:"")).filter((e=>!!e)).join(","),i=72e5,o={limit:t,query:`{${n}}`,expr:`{${n}}`,direction:s},l=new a.FieldCache(e.dataFrame).getFieldByName("tsNs").values.get(e.rowIndex);return"BACKWARD"===s?Object.assign({},o,{start:e.timeEpochMs-i+"000000",end:l,direction:s}):Object.assign({},o,{start:l,end:e.timeEpochMs+i+"000000"})})),this.instanceSettings=e,this.templateSrv=r,this.timeSrv=l,this.languageProvider=new pe(this);const p=e.jsonData||{};this.maxLines=parseInt(null!==(s=p.maxLines)&&void 0!==s?s:"0",10)||1e3}_request(e,t,s){const a=this.instanceSettings.url,r=t?(0,he.tW)(t):"",n=`${a}${e}${r.length?`?${r}`:""}`;(this.instanceSettings.withCredentials||this.instanceSettings.basicAuth)&&(s=Object.assign({},s,{withCredentials:!0}),this.instanceSettings.basicAuth&&(s.headers=Object.assign({},s.headers,{Authorization:this.instanceSettings.basicAuth})));const i=Object.assign({},s,{url:n});return(0,m.getBackendSrv)().fetch(i)}getLogsVolumeDataProvider(e){if(!fe.ZP.featureToggles.fullRangeLogsVolume)return;if(!e.targets.some((e=>e.expr&&!Te(e.expr))))return;const t=(0,r.cloneDeep)(e);return t.targets=t.targets.filter((e=>e.expr&&!Te(e.expr))).map((e=>Object.assign({},e,{instant:!1,volumeQuery:!0,expr:`sum by (level) (count_over_time(${e.expr}[$__interval]))`}))),(0,ge.Bz)(this,t,{timeout:1e4,extractLevel:Se,range:e.range,targets:e.targets})}query(e){const t=[],s=Object.assign({},e.scopedVars,this.getRangeScopedVars(e.range)),n=e.targets.filter((e=>e.expr&&!e.hide)).map((e=>{const t=this.addAdHocFilters(e.expr);return Object.assign({},e,{expr:this.templateSrv.replace(t,s,this.interpolateQueryExpr)})}));for(const s of n)s.instant?t.push(this.runInstantQuery(s,e,n.length)):t.push(this.runRangeQuery(s,e,n.length));return(0,r.isEmpty)(t)?(0,o.of)({data:[],state:a.LoadingState.Done}):(0,l.T)(...t)}createRangeQuery(e,t,s){const a=e.expr;let r={};if(t.range){const s=this.getTime(t.range.from,!1),a=this.getTime(t.range.to,!0),n=Math.ceil((a-s)/1e6),i=e.resolution||me.TQ.value,o=this.adjustInterval(t.intervalMs||1e3,i,n)/1e3;r={start:s,end:a,step:Math.ceil(1e3*o)/1e3}}return Object.assign({},je,r,{query:a,limit:s})}createLiveTarget(e,t){const s=e.expr,a=this.instanceSettings.url,r=(0,he.tW)({query:s});return{query:s,url:(0,y.F3)(`${a}/loki/api/v1/tail?${r}`),refId:e.refId,size:t}}getRangeScopedVars(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeSrv.timeRange();const t=e.to.diff(e.from),s=Math.round(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:s,value:s},__range:{text:s+"s",value:s+"s"}}}interpolateVariablesInQueries(e,t){let s=e;return e&&e.length&&(s=e.map((e=>Object.assign({},e,{datasource:this.getRef(),expr:this.templateSrv.replace(e.expr,t,this.interpolateQueryExpr)})))),s}getQueryDisplayText(e){return e.expr}getTimeRangeParams(){const e=this.timeSrv.timeRange();return{start:e.from.valueOf()*ye,end:e.to.valueOf()*ye}}async importQueries(e,t){return this.languageProvider.importQueries(e,t)}async metadataRequest(e,t){const s=await(0,i.n)(this._request(e,t,{hideFromInspector:!0}));return s.data.data||s.data.values||[]}async metricFindQuery(e){if(!e)return Promise.resolve([]);const t=this.templateSrv.replace(e,{},this.interpolateQueryExpr);return await this.processMetricFindQuery(t)}async processMetricFindQuery(e){if(e.match(/^label_names\(\)\s*$/))return await this.labelNamesQuery();const t=e.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/);return t?t[1]?await this.labelValuesSeriesQuery(t[1],t[2]):await this.labelValuesQuery(t[2]):Promise.resolve([])}async labelNamesQuery(){const e=this.getTimeRangeParams();return(await this.metadataRequest("/loki/api/v1/label",e)).map((e=>({text:e})))}async labelValuesQuery(e){const t=this.getTimeRangeParams(),s=`/loki/api/v1/label/${e}/values`;return(await this.metadataRequest(s,t)).map((e=>({text:e})))}async labelValuesSeriesQuery(e,t){const s=this.getTimeRangeParams(),a=Object.assign({},s,{"match[]":e}),r=new Set;return(await this.metadataRequest("/loki/api/v1/series",a)).forEach((e=>{e[t]&&r.add({text:e[t]})})),Array.from(r)}async getTagKeys(){return await this.labelNamesQuery()}async getTagValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return await this.labelValuesQuery(e.key)}interpolateQueryExpr(e,t){if(!t.multi&&!t.includeAll)return ke(e);if("string"==typeof e)return Le(e);return(0,r.map)(e,Le).join("|")}modifyQuery(e,t){var s;let a=null!==(s=e.expr)&&void 0!==s?s:"";switch(t.type){case"ADD_FILTER":a=this.addLabelToQuery(a,t.key,t.value,"=");break;case"ADD_FILTER_OUT":a=this.addLabelToQuery(a,t.key,t.value,"!=")}return Object.assign({},e,{expr:a})}getTime(e,t){return"string"==typeof e&&(e=a.dateMath.parse(e,t)),Math.ceil(1e6*e.valueOf())}testDatasource(){const e=`${Date.now()-6e5}000000`;return(0,i.n)(this._request("/loki/api/v1/label",{start:e}).pipe((0,c.U)((e=>{var t,s;return((null==e||null===(t=e.data)||void 0===t?void 0:t.data)||(null==e||null===(s=e.data)||void 0===s?void 0:s.values)||[]).length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that Loki and Promtail is configured properly."}})),(0,u.K)((e=>{let t="Loki: ";return e.statusText?t+=e.statusText:t+="Cannot connect to Loki",e.status&&(t+=`. ${e.status}`),e.data&&e.data.message?t+=`. ${e.data.message}`:e.data&&(t+=`. ${e.data}`),(0,o.of)({status:"error",message:t})}))))}async annotationQuery(e){const{expr:t,maxLines:s,instant:r,stepInterval:n,tagKeys:o="",titleFormat:l="",textFormat:c=""}=e.annotation;if(!t)return[];const u=this.templateSrv.replace(t,{},this.interpolateQueryExpr),d={refId:`annotation-${e.annotation.name}`,expr:u,maxLines:s,instant:r,stepInterval:n},{data:p}=r?await(0,i.n)(this.runInstantQuery(d,e)):await(0,i.n)(this.runRangeQuery(d,e)),h=[],m=o.split(",").filter((e=>""!==e));for(const e of p){const t={};for(const s of e.fields)if(s.labels)for(const[e,a]of Object.entries(s.labels))t[e]=String(a).trim();const s=[...new Set(Object.entries(t).reduce(((e,t)=>{let[s,a]=t;return""===a||m.length&&!m.includes(s)||e.push.apply(e,[a]),e}),[]))];new a.DataFrameView(e).forEach((e=>{h.push({time:new Date(e.ts).valueOf(),title:we(l,t),text:we(c,t)||e.line,tags:s})}))}return h}showContextToggle(e){return!0===(e&&e.searchWords&&e.searchWords.length>0)}processError(e,t){let s=(0,r.cloneDeep)(e);return e.data.message.includes("escape")&&t.expr.includes("\\")&&(s.data.message=`Error: ${e.data.message}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`),s}adjustInterval(e,t,s){let a=s/11e3;return a>1&&(a=Math.ceil(a)),Math.max(t*e,a)}addAdHocFilters(e){let t=e;return t=this.templateSrv.getAdhocFilters(this.name).reduce(((e,t)=>{const{key:s,operator:a}=t;let{value:r}=t;return"=~"!==a&&"!~"!==a||(r=ke(r)),this.addLabelToQuery(e,s,r,a)}),t),t}addLabelToQuery(e,t,s,a){return function(e){const t=S.uR.map((e=>`${e.label}`)).join("|");return new RegExp(`\\|\\s?(${t})`).test(e)}(e)&&!Te(e)?function(e,t,s,a){return e+` | ${t}${a}"${s.toString()}"`}(e,t,s,a):(0,f.F2)(e,t,s,a,!0)}}function we(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,((e,s)=>t[s]?t[s]:""))}function ke(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function Le(e){return"string"==typeof e?ke(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()|]/g,"\\\\$&")):e}function Te(e){return h().tokenize(e,S.ZP).some((e=>"string"!=typeof e&&"function"===e.type))}function Se(e){var t;let s;try{s=new a.FieldCache(e).getFirstFieldOfType(a.FieldType.number)}catch{}return null!==(t=s)&&void 0!==t&&t.labels?function(e){const t=["level","lvl","loglevel"];let s;for(let a of t)if(a in e){s=a;break}return s?(0,a.getLogLevelFromKey)(e[s]):a.LogLevel.unknown}(s.labels):a.LogLevel.unknown}const Ce=_e;var Fe,$e,Ie,Oe,Re,Qe,Ne,De,qe,Ee=s("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),Ve=s("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");function Ae(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const ze=['{job="default/prometheus"}'],Ue=["job","app","k8s_app"],Pe=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, filters out logs that don’t contain the word "metrics" and parses each log line to extract more labels and filters with them.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class Me extends Ee.PureComponent{constructor(){super(...arguments),Ae(this,"state",{userExamples:[]}),Ae(this,"checkUserLabels",(async()=>{var e;const t=null===(e=this.props.datasource)||void 0===e?void 0:e.languageProvider;if(t.started){const e=t.getLabelKeys()||[],s=Ue.find((t=>e.includes(t)));if(s){const e=await t.getLabelValues(s),a=(0,r.shuffle)(e).slice(0,5).map((e=>`{${s}="${e}"}`));this.setState({userExamples:a})}}else this.scheduleUserLabelChecking()}))}componentDidMount(){this.scheduleUserLabelChecking()}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(e){const{onClickExample:t}=this.props;return(0,Ve.jsx)("div",{className:"cheat-sheet-item__example",onClick:s=>t({refId:"A",expr:e}),children:(0,Ve.jsx)("code",{children:e})},e)}render(){const{userExamples:e}=this.state,t=e.length>0;return(0,Ve.jsxs)("div",{children:[Fe||(Fe=(0,Ve.jsx)("h2",{children:"Loki Cheat Sheet"})),(0,Ve.jsxs)("div",{className:"cheat-sheet-item",children:[$e||($e=(0,Ve.jsx)("div",{className:"cheat-sheet-item__title",children:"See your logs"})),Ie||(Ie=(0,Ve.jsx)("div",{className:"cheat-sheet-item__label",children:"Start by selecting a log stream from the Log browser, or alternatively you can write a stream selector into the query field."})),t?(0,Ve.jsxs)("div",{children:[Oe||(Oe=(0,Ve.jsx)("div",{className:"cheat-sheet-item__label",children:"Here are some example streams from your logs:"})),e.map((e=>this.renderExpression(e)))]}):(0,Ve.jsxs)("div",{children:[Re||(Re=(0,Ve.jsx)("div",{className:"cheat-sheet-item__label",children:"Here is an example of a log stream:"})),this.renderExpression(ze[0])]})]}),(0,Ve.jsxs)("div",{className:"cheat-sheet-item",children:[Qe||(Qe=(0,Ve.jsx)("div",{className:"cheat-sheet-item__title",children:"Combine stream selectors"})),this.renderExpression('{app="cassandra",namespace="prod"}'),Ne||(Ne=(0,Ve.jsx)("div",{className:"cheat-sheet-item__label",children:"Returns all log lines from streams that have both labels."}))]}),(0,Ve.jsxs)("div",{className:"cheat-sheet-item",children:[De||(De=(0,Ve.jsx)("div",{className:"cheat-sheet-item__title",children:"Filtering for search terms."})),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),qe||(qe=(0,Ve.jsxs)("div",{className:"cheat-sheet-item__label",children:[(0,Ve.jsx)("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql",children:"LogQL"})," ","supports exact and regular expression filters."]}))]}),Pe.map((e=>(0,Ve.jsxs)("div",{className:"cheat-sheet-item",children:[(0,Ve.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),this.renderExpression(e.expression),(0,Ve.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.expression)))]})}}var We=s("./public/app/plugins/datasource/loki/components/LokiQueryField.tsx");function Ke(e){var t;const{query:s,data:a,datasource:r,history:n,onChange:i,onRunQuery:o,range:l}=e;return(0,Ve.jsx)(We.n,{datasource:r,query:s,onChange:i,onBlur:()=>{},onRunQuery:o,history:n,data:a,range:l,ExtraFieldElement:(0,Ve.jsx)(me.JX,{queryType:s.instant?"instant":"range",lineLimitValue:(null==s||null===(t=s.maxLines)||void 0===t?void 0:t.toString())||"",resolution:s.resolution||1,query:s,onRunQuery:o,onChange:i})})}const Be=(0,Ee.memo)(Ke);var Ze,He=s("./packages/grafana-ui/src/index.ts");function Je(e){var t;const{query:s,data:a,datasource:r,onChange:n,onRunQuery:i,range:o}=e,l=(0,Ve.jsx)("div",{className:"gf-form-inline",children:(0,Ve.jsxs)("div",{className:"gf-form",children:[Ze||(Ze=(0,Ve.jsx)(He.InlineFormLabel,{width:6,tooltip:"Controls the name of the time series, using name or pattern. For example {{hostname}} will be replaced with label value for the label hostname. The legend only applies to metric queries.",children:"Legend"})),(0,Ve.jsx)("input",{type:"text",className:"gf-form-input",placeholder:"legend format",value:s.legendFormat||"",onChange:e=>{const t=Object.assign({},s,{legendFormat:e.currentTarget.value});n(t)},onBlur:i})]})});return(0,Ve.jsx)(We.n,{datasource:r,query:s,onChange:n,onRunQuery:i,onBlur:i,history:[],data:a,"data-testid":Xe.editor,range:o,ExtraFieldElement:(0,Ve.jsxs)(Ve.Fragment,{children:[(0,Ve.jsx)(me.JX,{queryType:s.instant?"instant":"range",lineLimitValue:(null==s||null===(t=s.maxLines)||void 0===t?void 0:t.toString())||"",resolution:(null==s?void 0:s.resolution)||1,query:s,onRunQuery:i,onChange:n,runOnBlur:!0}),l]})})}const Xe={editor:"loki-editor"};function Ye(e){const{query:t,data:s,datasource:a,onChange:r,onRunQuery:n}=e;return(0,Ve.jsx)(We.n,{datasource:a,query:t,onChange:r,onRunQuery:n,onBlur:n,history:[],data:s,placeholder:"Enter a Loki query","data-testid":Ge.editor})}const Ge={editor:"loki-editor-cloud-alerting"};function et(e){const{app:t}=e;return t===a.CoreApp.CloudAlerting?(0,Ve.jsx)(Ye,Object.assign({},e)):(0,Ve.jsx)(Je,Object.assign({},e))}const tt=(0,Ee.memo)(et);class st{constructor(e){this.annotation=e.ctrl.annotation,this.annotation.target=this.annotation.target||{},this.onQueryChange=this.onQueryChange.bind(this)}onQueryChange(e){this.annotation.expr=e.expr,this.annotation.maxLines=e.maxLines,this.annotation.instant=e.instant}}var at,rt,nt;st.$inject=["$scope"],nt="partials/annotations.editor.html",(rt="templateUrl")in(at=st)?Object.defineProperty(at,rt,{value:nt,enumerable:!0,configurable:!0,writable:!0}):at[rt]=nt;const{FormField:it}=He.LegacyForms,ot=e=>{const{value:t,onChange:s}=e;return(0,Ve.jsx)(it,{label:"Maximum lines",labelWidth:11,inputWidth:20,inputEl:(0,Ve.jsx)("input",{type:"number",className:"gf-form-input width-8 gf-form-input--has-help-icon",value:t,onChange:e=>s(e.currentTarget.value),spellCheck:!1,placeholder:"1000"}),tooltip:(0,Ve.jsx)(Ve.Fragment,{children:"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results."})})};var lt=s("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/0/cache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),ct=s("./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/esm/usePrevious.js");const{Switch:ut,FormField:dt}=He.LegacyForms,pt=(0,He.stylesFactory)((()=>({row:lt.css`
    display: flex;
    align-items: baseline;
  `,nameField:lt.css`
    flex: 2;
  `,regexField:lt.css`
    flex: 3;
  `,urlField:lt.css`
    flex: 1;
  `,urlDisplayLabelField:lt.css`
    flex: 1;
  `}))),ht=e=>{const{value:t,onChange:s,onDelete:a,suggestions:r,className:n}=e,i=pt(),[o,l]=(0,Ee.useState)(!!t.datasourceUid),c=(0,ct.Z)(t.datasourceUid);(0,Ee.useEffect)((()=>{c||!t.datasourceUid||o||l(!0),c&&!t.datasourceUid&&o&&l(!1)}),[c,t.datasourceUid,o]);const u=e=>a=>{s(Object.assign({},t,{[e]:a.currentTarget.value}))};return(0,Ve.jsxs)("div",{className:n,children:[(0,Ve.jsxs)("div",{className:i.row,children:[(0,Ve.jsx)(dt,{className:i.nameField,labelWidth:5,inputWidth:null,label:"Name",type:"text",value:t.name,onChange:u("name")}),(0,Ve.jsx)(dt,{className:i.regexField,inputWidth:null,label:"Regex",type:"text",value:t.matcherRegex,onChange:u("matcherRegex"),tooltip:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),(0,Ve.jsx)(He.Button,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),a()},className:lt.css`
            margin-left: 8px;
          `})]}),(0,Ve.jsxs)("div",{className:i.row,children:[(0,Ve.jsx)(dt,{label:o?"Query":"URL",inputEl:(0,Ve.jsx)(He.DataLinkInput,{placeholder:o?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>s(Object.assign({},t,{url:e})),suggestions:r}),className:i.urlField}),(0,Ve.jsx)(dt,{className:i.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:u("urlDisplayLabel"),tooltip:"Use to override the button label when this derived field is found in a log."})]}),(0,Ve.jsxs)("div",{className:i.row,children:[(0,Ve.jsx)(ut,{label:"Internal link",checked:o,onChange:()=>{o&&s(Object.assign({},t,{datasourceUid:void 0})),l(!o)}}),o&&(0,Ve.jsx)(m.DataSourcePicker,{tracing:!0,onChange:e=>s(Object.assign({},t,{datasourceUid:e.uid})),current:t.datasourceUid})]})]})};var mt,gt=s("./.yarn/cache/classnames-npm-2.2.6-98e9901cf4-09a4fda780.zip/node_modules/classnames/index.js"),ft=s.n(gt),bt=s("./public/app/features/explore/utils/links.ts");const{FormField:yt}=He.LegacyForms,vt=e=>{const{derivedFields:t,className:s}=e,[r,n]=(0,Ee.useState)("");let i=[];return r&&t&&(i=function(e,t){return e.filter((e=>e.name&&e.matcherRegex)).map((e=>{try{const s=t.match(e.matcherRegex),r=s&&s[1];let n=null;return e.url&&r&&(n=(0,bt.a)({field:{name:"",type:a.FieldType.string,values:new a.ArrayVector([r]),config:{links:[{title:"",url:e.url}]}},rowIndex:0,range:{}})[0]),{name:e.name,value:r||"<no match>",href:n&&n.href}}catch(t){return{name:e.name,error:t}}}))}(t,r)),(0,Ve.jsxs)("div",{className:s,children:[(0,Ve.jsx)(yt,{labelWidth:12,label:"Debug log message",inputEl:(0,Ve.jsx)("textarea",{placeholder:"Paste an example log line here to test the regular expressions of your derived fields",className:ft()("gf-form-input gf-form-textarea",lt.css`
                width: 100%;
              `),value:r,onChange:e=>n(e.currentTarget.value)})}),!!i.length&&(0,Ve.jsx)(xt,{fields:i})]})},xt=e=>{let{fields:t}=e;return(0,Ve.jsxs)("table",{className:"filter-table",children:[mt||(mt=(0,Ve.jsx)("thead",{children:(0,Ve.jsxs)("tr",{children:[(0,Ve.jsx)("th",{children:"Name"}),(0,Ve.jsx)("th",{children:"Value"}),(0,Ve.jsx)("th",{children:"Url"})]})})),(0,Ve.jsx)("tbody",{children:t.map((e=>{let t=e.value;return e.error?t=e.error.message:e.href&&(t=(0,Ve.jsx)("a",{href:e.href,children:t})),(0,Ve.jsxs)("tr",{children:[(0,Ve.jsx)("td",{children:e.name}),(0,Ve.jsx)("td",{children:t}),(0,Ve.jsx)("td",{children:e.href?(0,Ve.jsx)("a",{href:e.href,children:e.href}):""})]},`${e.name}=${e.value}`)}))})]})};var jt;const _t=e=>{const{value:t,onChange:s}=e,r=(e=>({infoText:lt.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,derivedField:lt.css`
    margin-bottom: ${e.spacing(1)};
  `}))((0,He.useTheme2)()),[n,i]=(0,Ee.useState)(!1);return(0,Ve.jsxs)(Ve.Fragment,{children:[jt||(jt=(0,Ve.jsx)("h3",{className:"page-heading",children:"Derived fields"})),(0,Ve.jsx)("div",{className:r.infoText,children:"Derived fields can be used to extract new fields from a log message and create a link from its value."}),(0,Ve.jsxs)("div",{className:"gf-form-group",children:[t&&t.map(((e,n)=>(0,Ve.jsx)(ht,{className:r.derivedField,value:e,onChange:e=>{const a=[...t];a.splice(n,1,e),s(a)},onDelete:()=>{const e=[...t];e.splice(n,1),s(e)},suggestions:[{value:a.DataLinkBuiltInVars.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:a.VariableOrigin.Value}]},n))),(0,Ve.jsxs)("div",{children:[(0,Ve.jsx)(He.Button,{variant:"secondary",className:lt.css`
              margin-right: 10px;
            `,icon:"plus",onClick:e=>{e.preventDefault();const a=[...t||[],{name:"",matcherRegex:""}];s(a)},children:"Add"}),t&&t.length>0&&(0,Ve.jsx)(He.Button,{variant:"secondary",type:"button",onClick:()=>i(!n),children:n?"Hide example log message":"Show example log message"})]})]}),n&&(0,Ve.jsx)("div",{className:"gf-form-group",children:(0,Ve.jsx)(vt,{className:lt.css`
              margin-bottom: 10px;
            `,derivedFields:t})})]})};var wt=s("./public/app/features/alerting/unified/utils/alertmanager.ts");const kt=e=>(t,s)=>Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s})}),Lt=kt("maxLines"),Tt=kt("derivedFields"),St=new a.DataSourcePlugin(Ce).setQueryEditor(tt).setConfigEditor((e=>{const{options:t,onOptionsChange:s}=e,a=(0,wt.Tc)();return(0,Ve.jsxs)(Ve.Fragment,{children:[(0,Ve.jsx)(He.DataSourceHttpSettings,{defaultUrl:"http://localhost:3100",dataSourceConfig:t,showAccessOptions:!1,onChange:s}),(0,Ve.jsx)(He.AlertingSettings,{alertmanagerDataSources:a,options:t,onOptionsChange:s}),(0,Ve.jsx)("div",{className:"gf-form-group",children:(0,Ve.jsx)("div",{className:"gf-form-inline",children:(0,Ve.jsx)("div",{className:"gf-form",children:(0,Ve.jsx)(ot,{value:t.jsonData.maxLines||"",onChange:e=>s(Lt(t,e))})})})}),(0,Ve.jsx)(_t,{value:t.jsonData.derivedFields,onChange:e=>s(Tt(t,e))})]})})).setExploreQueryField(Be).setQueryEditorHelp(Me).setAnnotationQueryCtrl(st)}}]);
//# sourceMappingURL=lokiPlugin.07a78e2e5dfa22b54847.js.map